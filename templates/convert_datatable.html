{% extends "layouts/base.html" %}

{% block title %}Simple DataTables{% endblock %}

{% block stylesheets %}
<!-- Specific Page CSS goes HERE -->
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">
<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous"> -->
<!-- APP Style -->
<link type="text/css" href="/static/datatables/app.css" rel="stylesheet">
{% endblock stylesheets %}

{% block content %}

<div class="card mt-4 justify-content-center text-center">
    <div class="card-body">
        <table id="data-table" class="table mx-auto" style="width: 100%;">
            <!-- <thead>
                <tr>
                    <th>Br Code</th>
                    <th>Branch Name</th>
                    <th>Supplier Code</th>
                    <th>Supplier Name</th>
                    <th>Item Count</th>
                    <th>Select</th>
                    <th>Save As</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>123</td>
                    <td>Wellness Forever (zedc)</td>
                    <td>123</td>
                    <td>ABC Suppliersss</td>
                    <td>111</td>
                    <td><input type="checkbox" name="" id=""></td>
                    <td><button class="btn btn-primary">Save & Approve</button></td>
                </tr>
            </tbody> -->
        </table>
        <!-- <div id="data-container"></div> -->

    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>

<script>
    // var table = new simpleDatatables.DataTable("#example");
        document.addEventListener("DOMContentLoaded", function () {
            const data = {{ data| tojson | safe
        }};

        const transformedData = [];

        Object.entries(data).forEach(([key, value]) => {
            const rowIndex = parseInt(key.split("[")[1]);
            const colIndex = parseInt(key.split("[")[2]);

            if (!transformedData[rowIndex]) {
                transformedData[rowIndex] = [];
            }

            transformedData[rowIndex][colIndex] = value;
            console.log(transformedData);
        });

        const dataArray = transformedData.filter(Boolean);
        console.log(dataArray);

        const table = new simpleDatatables.DataTable("#data-table", {
            data: {
                headings: [
                    "SI_Code",
                    "BR_Code",
                    "BR_Name",
                    "Item",
                    "Item_Name",
                    "Order_Qty",
                    "Supplier_Code",
                    "Supplier_Name"
                ],
                data: dataArray
            }
        });
    });


//     document.addEventListener("DOMContentLoaded", function () {
//         const dataContainer = document.getElementById("data-container");
//         const data = {{ data| tojson | safe
//     }};

//     console.log(data);

//     const transformedData = {};

//     Object.entries(data).forEach(([key, value]) => {
//         const rowIndex = parseInt(key.split("[")[1]);
//         const colIndex = parseInt(key.split("[")[2]);

//         if (!transformedData[rowIndex]) {
//             transformedData[rowIndex] = {};
//         }

//         switch (colIndex) {
//             case 0:
//                 transformedData[rowIndex].SI_Code = value;
//                 break;
//             case 1:
//                 transformedData[rowIndex].BR_Code = value;
//                 break;
//             case 2:
//                 transformedData[rowIndex].BR_Name = value;
//                 break;
//             case 6:
//                 transformedData[rowIndex].Supplier_Code = value;
//                 break;
//             case 7:
//                 transformedData[rowIndex].Supplier_Name = value;
//                 break;
//             default:
//                 break;
//         }
//     });

//     const dataArray = Object.values(transformedData);
//     const itemCounts = {};

//     dataArray.forEach((row) => {
//         const supplierCode = row.Supplier_Code;
//         itemCounts[supplierCode] = (itemCounts[supplierCode] || 0) + 1;
//     });

//     const mappedDataArray = dataArray.map((row) => {
//         const supplierCode = row.Supplier_Code;
//         return [
//             row.BR_Code,
//             row.BR_Name,
//             row.Supplier_Code,
//             row.Supplier_Name,
//             itemCounts[supplierCode],
//             '<button>Save & Approve</button>'
//         ];
//     });

//     const table = new simpleDatatables.DataTable("#data-table", {
//         data: {
//             headings: [
//                 "BR_Code",
//                 "BR_Name",
//                 "Supplier_Code",
//                 "Supplier_Name",
//                 "Item_Count",
//                 ""
//             ],
//             data: mappedDataArray
//         }
//     });
// });




</script>
<!-- <script src="//cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

<script>
    $(document).ready(function () {
        var data = {{ tble| safe
    }};

    $('#example tfoot th').each(function () {
        var title = $(this).text();
        $(this).html('<input type="text" placeholder="Search ' + title + '" />');
    });

    var exampleTable = $('#example').DataTable({
        data: data,
        columnDefs: [
            {
                className: "dt-body-center",
                targets: 5,
                defaultContent: ["<button class='editButton' data-toggle='modal' data-target='#orderModal'>View</button>"]
            },
            {
                className: "dt-body-center",
                targets: 6,
                defaultContent: ["<button class='appr' id='appr'>Approved</button> <button id='reject'>Rejected</button>"]
            }
        ],
        createdRow: function (row, data, dataIndex) {
            if (data[4] == "pending") {
                $(row).find('td:eq(4)').css('color', 'red');
            }
        },
        initComplete: function () {
            this.api().columns().every(function () {
                var that = this;
                $('input', this.footer()).on('keyup change clear', function () {
                    if (that.search() !== this.value) {
                        that.search(this.value).draw();
                    }
                });
            });

            var r = $('#example tfoot tr');
            r.find('th').each(function () {
                $(this).css('padding', 8);
            });
            $('#example thead').append(r);
            $('#search_0').css('text-align', 'center');
        }
    });

    $('#appr').on('click', function () {
        console.log('hel');
        var table = $('#example').DataTable();
        var data = table.row($(this).parents('tr')).data();
        console.log(data[4]);
        var row = this.parentNode.parentNode;
        alert(row.rowIndex);

        var confirmalert = confirm("Are you sure?");
        if (confirmalert == true) {
            table.cell(row, 4).data('Approved').draw();

            new_item = table.cell(row, 0).data(); //value I want to send
            $.ajax({
                url: '/deletevalue',
                type: 'POST',
                traditional: "true",
                data: {
                    "data1": new_item
                },
                dataType: "json"
            });
        }
    });

    $('#orderModal').modal({
        keyboard: true,
        backdrop: "static",
        show: false
    }).on('show.bs.modal', function (event) {
        console.log('hh');
        var getIdFromRow = $(event.relatedTarget).closest('tr').data();
        console.log(getIdFromRow);
        $(this).find('#orderDetails').html($('<b> Order Id selected: ' + getIdFromRow + '</b>'));
    });
});


</script> -->

<!-- <div id="orderModal" class="modal hide fade" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
        <h3>Order</h3>
    </div>
    <div id="orderDetails" class="modal-body"></div>
    <div id="orderItems" class="modal-body"></div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
</div> -->

{% endblock content %}